<div data-bind="if: model.currentView() == 'cohortdefinition'">
	<div class="wrapperTitle">
		<i class="fa fa-users"></i>
		<textarea maxlength="250" rows="1" class="cohortDefinitionNameTextArea" data-bind="textInput: model.currentCohortDefinition().name, jqAutoresize: {append: ''}, css: { emptyInput: !(model.currentCohortDefinition().name() && (model.currentCohortDefinition().name().length > 0)) }"></textarea>
	</div>

	<div class="button-overlay">
		<!-- ko if: model.currentCohortDefinition().id() != null -->
		<!-- ko ifnot: isRunning -->
		<button class="btn btn-sm btn-danger pull-right" data-bind="click: $component.delete">Delete Cohort Definition</button>
		<!-- /ko -->
		<button class="btn btn-sm btn-primary pull-right" data-bind="click: copy, enable: !dirtyFlag().isDirty()">Copy</button>
		<!-- ko if: isRunning -->
		<img class="spin" src="images/running.png" />Generating...
		<!-- /ko -->
		<!-- /ko -->
		<button class="btn btn-sm btn-primary pull-right" data-bind="click: showSql">Show SQL</button>
		<button class="btn btn-sm btn-success pull-right" data-bind="click: save, enable: (dirtyFlag().isDirty() && !isRunning()), css: {'disabled': !dirtyFlag().isDirty, 'btn-success': dirtyFlag().isDirty}">Save</button>
	</div>
	<div class="paddedWrapper">
		<ul class="nav nav-tabs">
			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'definition' }, click: function() { $component.tabMode('definition') };"><a>Definition</a>
			</li>

			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'conceptsets' }, click: function() { $component.tabMode('conceptsets') };"><a>Concept Sets</a>
			</li>


			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'generation' }, click: function() { $component.tabMode('generation') };"><a>Generation</a>
			</li>

			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'analysis' }, click: function() { $component.tabMode('analysis') };"><a>Analysis</a>
			</li>

			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'printfriendly' }, click: function() { $component.tabMode('printfriendly') };"><a>Print Friendly</a>
			</li>

		</ul>
		<!-- ko if: isGeneratedOpen -->
		<div title="Generated Sql..." data-bind="dialog: { isOpen: isGeneratedOpen, modal: true, width:700, height:500 }">
			<div class="tabs" data-bind="tabs: {}">
				<ul>
					<li data-bind="attr: { 'aria-controls': 'sql_server' }">
						<a data-bind="attr: { title: 'MSSQL Server', href: '#sql_server' }, text: 'MSSQL Server'"></a>
					</li>
					<li data-bind="attr: { 'aria-controls': 'sql_aps' }">
						<a data-bind="attr: { title: 'MS APS', href: '#ms_aps' }, text: 'MS APS'"></a>
					</li>
					<li data-bind="attr: { 'aria-controls': 'oracle' }">
						<a data-bind="attr: { title: 'Oracle', href: '#oracle' }, text: 'Oracle'"></a>
					</li>
					<li data-bind="attr: { 'aria-controls': 'postgres' }">
						<a data-bind="attr: { title: 'Postgres', href: '#postgres' }, text: 'Postgres'"></a>
					</li>
					<li data-bind="attr: { 'aria-controls': 'redshift' }">
						<a data-bind="attr: { title: 'Red Shift', href: '#redshift' }, text: 'Red Shift'"></a>
					</li>
				</ul>
				<div data-bind="attr: { id: 'sql_server' }">
					<pre data-bind="text: generatedSql.mssql"></pre>
				</div>
				<div data-bind="attr: { id: 'ms_aps' }">
					<pre data-bind="text: generatedSql.msaps"></pre>
				</div>
				<div data-bind="attr: { id: 'oracle' }">
					<pre data-bind="text: generatedSql.oracle"></pre>
				</div>
				<div data-bind="attr: { id: 'postgres' }">
					<pre data-bind="text: generatedSql.postgres"></pre>
				</div>
				<div data-bind="attr: { id: 'redshift' }">
					<pre data-bind="text: generatedSql.redshift"></pre>
				</div>
			</div>
		</div>
		<!-- /ko -->
		<div class="tab-content">
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'definition' }" class="tab-pane">
				<atlas.cohort-editor params="model: model"></atlas.cohort-editor>
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'conceptsets' }, eventListener: [{event: 'click', selector: '.repositoryConceptSetItem', callback: onConceptSetTabRespositoryConceptSetSelected}]" class="tab-pane">
				<table class="conceptSetTable stripe compact hover" cellspacing="0" width="100%" data-bind="dataTable:{
											data: model.currentCohortDefinition() && model.currentCohortDefinition().expression().ConceptSets,
											options: {
													deferRender: true,
													orderClasses: false,
													autoWidth: false,
													order: [ 1, 'asc' ],
													columnDefs: [
															{ width: '25px', targets: 0},
															{ width: '100%', targets: 1},
													],
													columns: [
															{ data: 'id', title: 'Id', width: '25px'},
															{ data: 'name', title: 'Title', width: '100%', className: 'repositoryConceptSetItem' },
													],
													language: {
															search: 'Filter Repository Concept Sets:'
													}
											}
									 }">
				</table>
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'printfriendly' }" class="tab-pane">
				<div class="paddedWrapper">
					<cohort-expression-viewer params="expression: model.currentCohortDefinition().expression"></cohort-expression-viewer>
					<br/>
					<div>Appendix 1: Concept Set Definitions</div>
					<br/>
					<!-- ko foreach: model.currentCohortDefinition().expression().ConceptSets.sorted -->
					<div><span data-bind="text: ($index() + 1)"></span>. <span data-bind="text: $data.name"></span></div>
					<div style="padding-left:20px">
						<conceptset-viewer params="{conceptSet: $data}"></conceptset-viewer>
						<br/>
					</div>
					<!-- /ko -->
				</div>
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'generation' }" class="tab-pane">
				<table class="configureSourceTable">
					<thead>
						<th></th>
						<th>Source Name</th>
						<th>Generation Status</th>
						<th>Distinct People</th>
						<th>Generated</th>
						<th>Generation Duration</th>
					</thead>
					<tbody data-bind="foreach:model.cohortDefinitionSourceInfo">
						<tr>
							<td>
								<div class="btn btn-xs btn-success" data-bind="click:$component.generateCohort"><i class="fa fa-play"></i></div>
							</td>
							<td data-bind="text:name"></td>
							<td class="statusIndicator rightaligned">
								<span class="fa" data-bind="css: { 'fa-check-circle' : isValid, 'fa-exclamation-circle' : !isValid }"></span>&nbsp;<span data-bind="text: status"></span>
							</td>
							<td class="rightaligned">
								<div><span data-bind="html: distinctPeople"></span>
								</div>
							</td>
							<td class="rightaligned">
								<div data-bind="text: startTime"></div>
							</td>
							<td class="rightaligned">
								<div data-bind="text: executionDuration"></div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'analysis' }" class="tab-pane">
				<table id="analysisStatus">
					<thead>
						<th>Analysis Type</th>
						<!-- ko foreach: $component.model.services()[0].sources.filter($component.model.hasCDM) -->
						<th data-bind="text:sourceName"></th>
						<!-- /ko -->
					</thead>
					<tbody>
						<!-- ko foreach:$component.model.cohortAnalyses -->
						<tr>
							<td data-bind="text:name"></td>
							<!-- ko foreach: $component.model.services()[0].sources.filter($component.model.hasCDM) -->
							<td class="statusIndicator">
								<!-- ko if:$component.model.sourceAnalysesStatus[sourceKey]().ready -->
								<i class="fa" data-bind="css: { 'fa-check-circle' : $component.model.sourceAnalysesStatus[sourceKey]()[$parent.name] > 0, 'fa-exclamation-triangle' : $component.model.sourceAnalysesStatus[sourceKey]()[$parent.name] == 0 }"></i>
								<input data-bind="attr: { name : sourceKey, value : $parent.name }" type="checkbox">
								<!-- /ko -->
								<!-- ko if:$component.model.sourceAnalysesStatus[sourceKey]().checking -->
								<i class="fa fa-refresh fa-spin"></i>
								<!-- /ko -->
								<!-- ko if:!$component.model.sourceAnalysesStatus[sourceKey]().checking && !$component.model.sourceAnalysesStatus[sourceKey]().ready -->
								<i class="fa fa-exclamation-circle"></i>
								<!-- /ko -->
							</td>
							<!-- /ko -->
						</tr>
						<!-- /ko -->
						<tr>
							<td style="border-bottom:0px;"></td>
							<!-- ko foreach: $component.model.services()[0].sources.filter($component.model.hasCDM) -->
							<td style="border-bottom:0px;padding:5px;" class="statusIndicator">
								<!-- ko if:$component.model.sourceAnalysesStatus[sourceKey]().ready -->
								<div data-bind="click:$component.generateAnalyses" class="btn btn-sm btn-primary">Generate</div>

								<a class="btn btn-sm btn-success" data-bind="attr: {href: $component.model.services()[0].url + sourceKey + '/cohortresults/' + $component.model.currentCohortDefinition().id + '/export.zip'}"><i class="fa fa-cloud-download"></i> Export</a>
								<!-- /ko -->
							</td>
							<!-- /ko -->
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
